language: python
python: 3.7

jobs:
  include:
    - python: 2.7
      evn: TOXENV=py27
      after_success: codecov
    - env: TOXENV=py37
      after_success: codecov
    - env: TOXENV=build
    - env: TOXENV=pre-commit
    - stage: Deploy to Test PyPI release
      env: TOXENV=build
      before_script: sed -i -E "s/^([0-9]+\.[0-9]+\.[0-9]+)$/\1.$TRAVIS_BUILD_NUMBER/" version.txt
      deploy:
        distributions: skip
        skip_cleanup: true
        provider: pypi
        server: https://test.pypi.org/legacy/
        user: "__token__"
        password:
          secure: "j6GDOjwRsuE6JuTsWhkSs96dFgl7UyXT2YrWtipDI7lLdxfSDpskOsXCZqMZUxzRt6Fxpw2kSupKhVgmBAzhVBz0zl2ZvjVb9wTN+PhMDyvB8n3VOgd29O02N9h9CNVgxDFAI7gpxNEOYIhjZ7VJw8p9qJSyRK3Rw/pY6eerOGfuezee9RCAx26gMRNRvBzgTiE7u4GnxGuMXqbI6JsYXGeuYV719q1/j8RQNdQ4kngQ9UzAtMZyqtOw8226+d6+NVKUaYQWjZsTkjI8fnWvVKVowbWgU/eDnir+IYekA8nxgbHGMPHp3onBy4LGuroYltdWBKGjNgAwsIwKIhDoS0C7dgDmTWJGmCgI/lVCAxhbg15EbCTqZKvAtzN1+BgnDqQtNcDTLLYtpG3VeJ7QaxCM/FcUAWhGR2przHKRvg1NUACGyYWX5UZv/ugNsMVphhqbzWAeY6VINxgrI/czucHVPKG0BK4JU3Qs3smTEq8VW+3ek2aBog4dF9HMwuyTM2vDYJDQx5zD6Wh+UNJG+LDJlCtvClRKbhW6P6BFxciSdZgH5WozUYipqGYzh/s5FjaLUM3CHKa1LuyvatOrDoNSOPNV559wN9/NEJbjwzcr3nTzof+G+Z1yYcjTHJOtnpsAoyncIkIftpsdDxzVdxJjdaZmty/KtEw61utk+SM="
        on:
          branch: dev
    - stage: Deploy to PyPI release
      env: TOXENV=build
      deploy:
        distributions: skip
        skip_cleanup: true
        provider: pypi
        user: "__token__"
        password:
          secure: "f+VMkhrZwIqRCNzpuVT6jI2JyR9L+SZVcmPfZf/EDQE6eVewv0NKGKrSY3znDmaJoK8NX2fYUgc9RFJVbK8eD+UjaFJdS4ackbJmsSPC7vvpIr68ZbGerPxZ16jg86NEZnJ/XRi/Jr0JTqS0yJ/ygtxaaZ8+3LP0RBaETX1xs/7C31rVvt902Jbaj/y3C5Gv12ySRADvXeNN6SMKb/hJJDKHIOv0TYTQBEJNWtUhtgTnLNEfw7+WRP3dgnkKeNEVcWrIwJUuY+hhYH7z0rLZDHXMMhRG66Z3HKCeWGBoMxOvHOMOAJPHXqx9WMroA/RSFhC6vvL0xXHWUcmYwBcB8o1r3u709UtgRRjHbOkdBVmbZ2qa03ylCYSfJfvj4f4N0tXXl/UlEWV8po//9chpYFflCbvVYQS1m6ZlO7o+Wv5LacksGh30rbqCC5y2IgUWNPQW99l+dedZ0GFZBwUPsU2aCLyfLL2wN+6OTi1CzJZt+qOzgRrMi9qdt/NnazGtjIv7wvRHBYhscT1Z1V4qIvdrpZRtnwKplImvSyicbx5BZSEliylDv8Q1y/RCPrY6+F3k8NETyBr0BW95swnphC6G+UmT8wCljaZU6RW4YWuOrYOPa0lmz1IQrRyGNVxchWprhQg0u3vppump6JVpdE0sxLjY5XsnbuziI37JStI="
        on:
          tags: true
    - stage: Create GitHub release
      env: TOXENV=build
      before_deploy:
        - export AUTHOR_EMAIL="$(git log -1 $TRAVIS_COMMIT --pretty="%cE")"
        - export AUTHOR_NAME="$(git log -1 $TRAVIS_COMMIT --pretty="%aN")"
        - export GIT_TAG="$(cat version.txt | tr -d ' \t\n\r')"
        - git config --local user.name $AUTHOR_NAME
        - git config --local user.email $AUTHOR_EMAIL
        - git tag $GIT_TAG
      deploy:
        provider: releases
        skip_cleanup: true
        draft: true
        api_key:
          secure: "hzebWFHPPrOSxMjTPbFolstqimZMz+JBUa/yn8YFbbAHxsg/ULAMEp7POuhrFi9U6FU8RWsMBpC+BwVY9ohIuWx4BYqCV7MjsfVahc07FuXfXer2nJ0RxBH8FMZ5od3pdCU8/i4LaTkEkOShz/WEanNp3TblovxiMnZupSH+Z7wQ+tuE/1hiMVSi8rozoJ5suCzUJdzQ0Fh0BmkRoB/XDBFFdboozhZg0RlWr2YTc81MN2QpzOuaUftucVU5IyOrMeAqzIVMdqBGE9FE4Mu4pP6sjvYmtnKTTmTnxFcT3OMwNPhFCHb/H6m3vDEx/B6xZGRibzYUkjuGvzjBDPA+u/goki3UcJekTpL/JOYeYiojbQKzVTKbdjH8tojrDimD4D1Vej1pNmfLEYYCUcEj6oWOrcoFMCdciJ0Iv/dziwYJbFNR5sZBBTxoKBJFoYyz0oZelP5jlJt/iP4u/IrJbUN78dSle91X5E/f4peHGHXu6NHfTynVlWPp7YFBilxIlnDcNcTIWKz8Dgz1j670TwXERcPKYC5W8RyP+OcNIsvFeuUmiQIf5se0s/Ts4uhjLRaCyqPs3VsBj6mr40OvZPL43m1eMaiwHg4f5ciGH2xmGhbFz/T1gqmawgCR9u9kG/cWGwPqQ6PiTaft3g/tIWxigT9Ka5O05S4TgaLo6G0="
        file_glob: true
        file: dist/*
        name: cloudshell-rest-api $GIT_TAG
        target_commitish: master
        on:
          branch: master
    - stage: Check version
      language: bash
      install:
        - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
        - cd $TRAVIS_REPO_SLUG
        - git checkout -qf $TRAVIS_PULL_REQUEST_BRANCH
      script: "! git diff --exit-code --quiet origin/master version.txt"

install:
    - pip install tox
    - pip install codecov

script: tox

stages:
  - name: Check version
    if: branch = master AND type = pull_request
  - name: Test
  - name: Deploy to Test PyPI release
    if: branch = dev AND type != pull_request
  - name: Create GitHub release
    if: branch = master AND type != pull_request
  - name: Deploy to PyPI release
    if: tag IS present
